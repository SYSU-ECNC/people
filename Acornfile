args: {
  userConfigData: {}
}

localData: {
  config: std.merge({
    wechat: {
      appId: ""
      appSecret: ""
    }
    lark: {
      appId: ""
      appSecret: ""
      welcomeLetterLink: ""
    }
    discourse: {
      secret: ""
    }
  }, args.userConfigData)
}

containers: {
  app: {
    build: "."
    env: {
      "DATABASE_URL": "secret://database-url/template"
      "NUXT_REDIS_URL": "redis://redis:6379/"
      "NUXT_WECHAT_APP_ID": "secret://env/wechatAppId"
      "NUXT_WECHAT_APP_SECRET": "secret://env/wechatAppSecret"
      "NUXT_LARK_APP_ID": "secret://env/larkAppId"
      "NUXT_LARK_APP_SECRET": "secret://env/larkAppSecret"
      "NUXT_LARK_WELCOME_LETTER_LINK": "secret://env/larkWelcomeLetterLink"
      "NUXT_DISCOURSE_SECRET": "secret://env/discourseSecret"
    }
    dependsOn: [
      "pg",
      "redis"
    ]
    ports: "3000/http"
  }
  redis: {
    image: "redis:alpine"
    ports: "6379/tcp"
  }
  pg: {
    image: "postgres:alpine"
    env: {
      "POSTGRES_DB": "people"
      "POSTGRES_PASSWORD": "secret://pg-pass/token"
    }
    dirs: {
      "/var/lib/postgresql/data": "volume://pgdata?subpath=data"
    }
    ports: "5432/tcp"
  }
}

volumes: {
  "pgdata": {
    accessModes: "readWriteOnce"
  }
  "redisdata": {
    accessModes: "readWriteOnce"
  }
}

secrets: {
  "pg-pass": {
    type: "token"
  }
  "database-url": {
    type: "template"
    data: {
      template: "postgresql://postgres:${secret://pg-pass/token}@pg:5432/people?schema=public"
    }
  }
  "env": {
    type: "opaque"
    data: {
      wechatAppId: localData.config.wechat.appId,
      wechatAppSecret: localData.config.wechat.appSecret
      larkAppId: localData.config.lark.appId,
      larkAppSecret: localData.config.lark.appSecret,
      larkWelcomeLetterLink: localData.config.lark.welcomeLetterLink,
      discourseSecret: localData.config.discourse.secret
    }
  }
}